jobs:
- job: Linux
  pool:
    vmImage: ubuntu-16.04
  variables:
    display: ":99"
  steps:
  - bash: |
      curl -s -L "https://atom.io/download/deb?channel=dev" \
        -H 'Accept: application/octet-stream' \
        -o 'atom-amd64.deb'
      /sbin/start-stop-daemon --start --quiet --pidfile /tmp/custom_xvfb_99.pid --make-pidfile --background --exec /usr/bin/Xvfb -- :99 -ac -screen 0 1280x1024x16
      sudo apt-get update && sudo apt-get install -yyq libgconf-2-4 build-essential git libsecret-1-dev
      dpkg-deb -x atom-amd64.deb /tmp/atom
    displayName: install Atom
  - bash: /tmp/atom/usr/share/atom-dev/resources/app/apm/bin/apm ci
    displayName: install dependencies
  - bash: /tmp/atom/usr/bin/atom-dev --test test/
    displayName: run tests

- job: MacOS
  pool:
    vmImage: macos-10.13
  steps:
  - bash: |
      set -x
      curl -s -L "https://atom.io/download/mac?channel=dev" \
        -H 'Accept: application/octet-stream' \
        -o "atom.zip"
      mkdir -p /tmp/atom
      unzip -q atom.zip -d /tmp/atom
      find /tmp/atom -name 'atom*'
      find /tmp/atom -name 'apm*'
    displayName: install Atom
  - bash: /tmp/atom/Atom\ Dev.app/Contents/Resources/app/apm/bin/apm ci
    displayName: install dependencies
  - bash: /tmp/atom/Atom\ Dev.app/Contents/Resources/app/atom.sh --test test/
    displayName: run tests

- job: Windows
  pool:
    vmImage: vs2015-win2012r2
  steps:
  - powershell: |
      Set-StrictMode -Version Latest
      $script:ATOMROOT = "$env:AGENT_HOME_DIRECTORY/atom"
      Set-Location $env:AGENT_BUILD_DIRECTORY

      $env:ELECTRON_NO_ATTACH_CONSOLE = "true"
      [Environment]::SetEnvironmentVariable("ELECTRON_NO_ATTACH_CONSOLE", "true", "User")
      $env:ELECTRON_ENABLE_LOGGING = "YES"
      [Environment]::SetEnvironmentVariable("ELECTRON_ENABLE_LOGGING", "YES", "User")

      $script:ATOM_SCRIPT_PATH = "$script:ATOMROOT\Atom Dev\resources\cli\atom.cmd"
      $script:APM_SCRIPT_PATH = "$script:ATOMROOT\Atom Dev\resources\app\apm\bin\apm.cmd"

      function DownloadAtom() {
        Write-Host "Downloading latest Atom release"
        $source = "https://atom.io/download/windows_zip?channel=dev"
        $destination = "atom.zip"

        (New-Object System.Net.WebClient).DownloadFile($source, $destination)
      }

      function ExtractAtom() {
        [System.IO.Compression.ZipFile]::ExtractToDirectory("atom.zip", $script:ATOMROOT)
      }

      function InstallDependencies() {
        Write-Host "Installing package dependencies"
        & "$script:APM_SCRIPT_PATH" ci
        if ($LASTEXITCODE -ne 0) {
            Write-Host "Dependency installation failed"
            $host.SetShouldExit($LASTEXITCODE)
            exit
        }
      }

      function RunTests() {
        Write-Host "Running tests"
        & "$script:ATOM_SCRIPT_PATH" --test test 2>&1 | %{ "$_" }

        if ($LASTEXITCODE -ne 0) {
            Write-Host "Specs Failed"
            $host.SetShouldExit($LASTEXITCODE)
            exit
        }
      }

      DownloadAtom
      ExtractAtom
      InstallDependencies
      RunTests
